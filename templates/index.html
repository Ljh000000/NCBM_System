<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络设备配置备份与管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .diff-added {
            background-color: #d4edda;
            color: #155724;
        }
        .diff-removed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .diff-header {
            font-weight: bold;
            background-color: #e9ecef;
        }
        .diff-hunk {
            background-color: #fff3cd;
            color: #856404;
        }
        .diff-context {
            background-color: #ffffff;
        }
        .backup-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .backup-item:hover {
            background-color: #f8f9fa;
        }
        .status-badge {
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-router"></i> 网络设备配置备份与管理系统
            </span>
            <div class="d-flex">
                <a href="/" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house"></i> 主页
                </a>
                <a href="/test" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-bug"></i> 测试页面
                </a>
                <span class="text-white ms-3" id="systemStatus"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 系统状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> 系统状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong>设备总数:</strong> <span id="totalDevices">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>备份总数:</strong> <span id="totalBackups">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>定时任务:</strong> 
                                <span id="schedulerStatus" class="badge bg-secondary">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>下次备份:</strong> <span id="nextBackup">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：设备列表和操作 -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-device-hdd"></i> 设备列表</h5>
                        <button class="btn btn-sm btn-success" onclick="showAddDeviceModal()">
                            <i class="bi bi-plus-circle"></i> 添加设备
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="deviceList" class="list-group">
                            <!-- 设备列表将在这里动态加载 -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> 操作</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100 mb-2" onclick="backupCurrentDevice()">
                            <i class="bi bi-download"></i> 手动备份当前设备
                        </button>
                        <button class="btn btn-secondary w-100" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新数据
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：备份历史和详情 -->
            <div class="col-md-8">
                <!-- 备份历史 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> 备份历史</h5>
                    </div>
                    <div class="card-body">
                        <div id="backupHistory">
                            <p class="text-muted">请选择一个设备查看备份历史</p>
                        </div>
                    </div>
                </div>

                <!-- 配置差异 -->
                <div class="card mb-3" id="diffCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-diff"></i> 配置差异</h5>
                    </div>
                    <div class="card-body">
                        <div id="diffContent" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                        </div>
                    </div>
                </div>

                <!-- 备份内容查看 -->
                <div class="card" id="backupViewCard" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-text"></i> 备份内容</h5>
                        <button class="btn btn-sm btn-secondary" onclick="closeBackupView()">
                            <i class="bi bi-x"></i> 关闭
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="backupContent" style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载提示模态框 -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-3" id="loadingMessage">处理中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 设备管理模态框 -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceModalTitle">添加设备</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceForm">
                        <input type="hidden" id="deviceFormMode" value="add">
                        <input type="hidden" id="deviceFormOldName" value="">
                        
                        <div class="mb-3">
                            <label for="deviceName" class="form-label">设备名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deviceName" required>
                            <small class="form-text text-muted">唯一标识设备的名称</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="deviceIp" class="form-label">IP地址 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deviceIp" placeholder="192.168.1.1" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="deviceUsername" class="form-label">用户名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deviceUsername" placeholder="admin" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="devicePassword" class="form-label">密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="devicePassword" required>
                            <small class="form-text text-muted" id="passwordHint">编辑时留空则保持原密码</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="deviceType" class="form-label">设备类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="deviceType" required>
                                <option value="cisco_ios">Cisco IOS</option>
                                <option value="cisco_ios_telnet">Cisco IOS (Telnet)</option>
                                <option value="huawei">华为</option>
                                <option value="h3c">H3C</option>
                                <option value="hp_comware">HP Comware</option>
                                <option value="juniper">Juniper</option>
                                <option value="linux">Linux</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDevice()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDevice = null;
        let loadingModal = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadDevices();
            loadSystemStatus();
            // 每30秒刷新一次系统状态
            setInterval(loadSystemStatus, 30000);
        });

        // 加载设备列表
        async function loadDevices() {
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch('/api/devices', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const deviceList = document.getElementById('deviceList');
                    if (!deviceList) {
                        console.warn('设备列表元素不存在');
                        return;
                    }
                    
                    deviceList.innerHTML = '';
                    
                    if (data.devices.length === 0) {
                        deviceList.innerHTML = '<p class="text-muted text-center py-3">暂无设备配置<br><small>点击"添加设备"按钮添加新设备</small></p>';
                        return;
                    }
                    
                    data.devices.forEach(device => {
                        try {
                            // 转义特殊字符，防止XSS
                            const safeName = device.name.replace(/'/g, "\\'");
                            const safeIp = (device.ip || '').replace(/"/g, '&quot;');
                            const safeUsername = (device.username || '').replace(/"/g, '&quot;');
                            const safeType = (device.type || '').replace(/"/g, '&quot;');
                            
                            const item = document.createElement('div');
                            item.className = 'list-group-item';
                            item.innerHTML = `
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1" style="cursor: pointer;" onclick="selectDevice('${safeName}')">
                                        <h6 class="mb-1">${device.name}</h6>
                                        <p class="mb-1 text-muted small">${safeIp} (${safeType})</p>
                                        <small class="text-muted">用户: ${safeUsername}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="event.stopPropagation(); editDevice('${safeName}', '${safeIp}', '${safeUsername}', '${safeType}')" title="编辑">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteDevice('${safeName}')" title="删除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            deviceList.appendChild(item);
                        } catch (err) {
                            console.error('渲染设备项失败:', err, device);
                        }
                    });
                } else {
                    console.error('加载设备列表失败:', data.message);
                    // 不显示错误提示，避免干扰用户
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('加载设备列表超时');
                } else {
                    console.error('加载设备列表失败:', error);
                }
                // 不显示错误提示，避免干扰用户
            }
        }

        // 选择设备
        function selectDevice(deviceName) {
            currentDevice = deviceName;
            // 更新选中状态
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            // 找到对应的列表项并高亮
            const items = document.querySelectorAll('.list-group-item');
            items.forEach(item => {
                if (item.textContent.includes(deviceName)) {
                    item.classList.add('active');
                }
            });
            
            loadBackupHistory(deviceName);
        }

        // 加载备份历史
        async function loadBackupHistory(deviceName) {
            if (!deviceName) {
                document.getElementById('backupHistory').innerHTML = '<p class="text-muted">请选择一个设备查看备份历史</p>';
                return;
            }
            
            // 先显示加载状态
            const historyDiv = document.getElementById('backupHistory');
            historyDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> 加载中...</p>';
            
            try {
                // 添加超时控制（缩短到5秒）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch(`/api/backup/history?device_name=${encodeURIComponent(deviceName)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP错误: ${response.status}` }));
                    throw new Error(errorData.message || `HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    if (data.history.length === 0) {
                        historyDiv.innerHTML = '<p class="text-muted">该设备暂无备份记录</p>';
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>时间</th><th>文件大小</th><th>操作</th></tr></thead><tbody>';
                    
                    data.history.forEach((backup, index) => {
                        // 转义特殊字符，防止XSS
                        const safeFileName = backup.file_name.replace(/'/g, "\\'");
                        const safeDeviceName = deviceName.replace(/'/g, "\\'");
                        
                        html += `
                            <tr>
                                <td>${backup.timestamp}</td>
                                <td>${backup.size_human}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewBackup('${safeDeviceName}', '${safeFileName}')">
                                        <i class="bi bi-eye"></i> 查看
                                    </button>
                                    <button class="btn btn-sm btn-outline-success me-1" onclick="restoreBackup('${safeDeviceName}', '${safeFileName}')">
                                        <i class="bi bi-arrow-counterclockwise"></i> 恢复
                                    </button>
                                    ${index < data.history.length - 1 ? `
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="compareBackups('${safeDeviceName}', '${data.history[0].file_name.replace(/'/g, "\\'")}', '${safeFileName}')">
                                        <i class="bi bi-file-diff"></i> 对比
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteBackup('${safeDeviceName}', '${safeFileName}')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    historyDiv.innerHTML = html;
                } else {
                    historyDiv.innerHTML = `<p class="text-danger">${data.message || '加载失败'}</p>`;
                    showAlert('error', data.message || '加载备份历史失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    historyDiv.innerHTML = '<p class="text-danger">加载超时，请重试</p>';
                    showAlert('error', '加载备份历史超时，请检查网络连接或服务器状态');
                } else {
                    historyDiv.innerHTML = `<p class="text-danger">加载失败: ${error.message}</p>`;
                    showAlert('error', '加载备份历史失败: ' + error.message);
                }
                console.error('加载备份历史错误:', error);
            }
        }

        // 手动备份
        async function backupCurrentDevice() {
            if (!currentDevice) {
                showAlert('warning', '请先选择一个设备');
                return;
            }
            
            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒超时（备份可能需要较长时间）

                const response = await fetch('/api/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_name: currentDevice
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('success', '备份完成！');
                    
                    // 异步刷新，不阻塞界面
                    setTimeout(() => {
                        loadBackupHistory(currentDevice).catch(err => {
                            console.error('刷新备份历史失败:', err);
                        });
                        loadSystemStatus().catch(err => {
                            console.error('更新系统状态失败:', err);
                        });
                    }, 0);
                } else {
                    showAlert('error', data.message || '备份失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '备份超时，请检查网络连接或设备状态');
                } else {
                    showAlert('error', '备份失败: ' + (error.message || '未知错误'));
                }
                console.error('备份失败:', error);
            }
        }

        // 查看备份内容
        async function viewBackup(deviceName, backupFile) {
            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                const response = await fetch(`/api/backup/view?device_name=${encodeURIComponent(deviceName)}&backup_file=${encodeURIComponent(backupFile)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('backupContent').textContent = data.content;
                    document.getElementById('backupViewCard').style.display = 'block';
                    document.getElementById('diffCard').style.display = 'none';
                } else {
                    showAlert('error', data.message || '加载失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '加载备份内容超时，请检查网络连接');
                } else {
                    showAlert('error', '加载备份内容失败: ' + (error.message || '未知错误'));
                }
                console.error('加载备份内容失败:', error);
            }
        }

        // 关闭备份查看
        function closeBackupView() {
            document.getElementById('backupViewCard').style.display = 'none';
        }

        // 对比备份
        async function compareBackups(deviceName, backup1, backup2) {
            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时（对比可能需要较长时间）

                const response = await fetch(`/api/diff?device_name=${encodeURIComponent(deviceName)}&backup1=${encodeURIComponent(backup1)}&backup2=${encodeURIComponent(backup2)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const diffContent = document.getElementById('diffContent');
                    
                    if (!data.has_changes) {
                        diffContent.innerHTML = '<p class="text-success">配置无变更</p>';
                    } else {
                        // 格式化差异显示
                        const diffLines = data.diff.split('\n');
                        let html = `<p><strong>对比文件:</strong> ${data.backup1} vs ${data.backup2}</p>`;
                        html += `<p><strong>摘要:</strong> ${data.summary}</p>`;
                        html += '<hr><pre style="margin: 0;">';
                        
                        diffLines.forEach(line => {
                            if (line.startsWith('+++') || line.startsWith('---')) {
                                html += `<span class="diff-header">${escapeHtml(line)}</span>\n`;
                            } else if (line.startsWith('@@')) {
                                html += `<span class="diff-hunk">${escapeHtml(line)}</span>\n`;
                            } else if (line.startsWith('+')) {
                                html += `<span class="diff-added">${escapeHtml(line)}</span>\n`;
                            } else if (line.startsWith('-')) {
                                html += `<span class="diff-removed">${escapeHtml(line)}</span>\n`;
                            } else {
                                html += `<span class="diff-context">${escapeHtml(line)}</span>\n`;
                            }
                        });
                        
                        html += '</pre>';
                        diffContent.innerHTML = html;
                    }
                    
                    document.getElementById('diffCard').style.display = 'block';
                    document.getElementById('backupViewCard').style.display = 'none';
                } else {
                    showAlert('error', data.message || '对比失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '对比配置超时，请检查网络连接');
                } else {
                    showAlert('error', '对比配置失败: ' + (error.message || '未知错误'));
                }
                console.error('对比配置失败:', error);
            }
        }

        // 恢复配置
        async function restoreBackup(deviceName, backupFile) {
            if (!confirm(`⚠️ 警告：确定要将设备 ${deviceName} 的配置恢复为 ${backupFile} 吗？\n\n此操作将覆盖当前设备配置，请谨慎操作！`)) {
                return;
            }
            
            // 二次确认
            if (!confirm(`再次确认：您真的要恢复配置吗？此操作不可撤销！`)) {
                return;
            }
            
            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60秒超时（恢复配置可能需要较长时间）

                const response = await fetch('/api/restore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_name: deviceName,
                        backup_file: backupFile
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('success', '配置恢复成功！');
                    // 显示恢复输出（如果有）
                    if (data.output) {
                        console.log('恢复输出:', data.output);
                    }
                    // 异步刷新备份历史，不阻塞界面
                    setTimeout(() => {
                        loadBackupHistory(deviceName).catch(err => {
                            console.error('刷新备份历史失败:', err);
                        });
                    }, 0);
                } else {
                    showAlert('error', '配置恢复失败: ' + (data.message || '未知错误'));
                    if (data.output) {
                        console.error('恢复输出:', data.output);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '恢复配置超时，请检查网络连接或设备状态');
                } else {
                    showAlert('error', '恢复失败: ' + (error.message || '未知错误'));
                }
                console.error('恢复失败:', error);
            }
        }

        // 删除备份
        async function deleteBackup(deviceName, backupFile) {
            if (!confirm(`确定要删除备份文件 ${backupFile} 吗？`)) {
                return;
            }
            
            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                const response = await fetch(`/api/backup?device_name=${encodeURIComponent(deviceName)}&backup_file=${encodeURIComponent(backupFile)}`, {
                    method: 'DELETE',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert('success', '备份文件已删除');
                    
                    // 异步刷新，不阻塞界面
                    setTimeout(() => {
                        loadBackupHistory(deviceName).catch(err => {
                            console.error('刷新备份历史失败:', err);
                        });
                        loadSystemStatus().catch(err => {
                            console.error('更新系统状态失败:', err);
                        });
                    }, 0);
                } else {
                    showAlert('error', data.message || '删除失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '删除备份超时，请检查网络连接');
                } else {
                    showAlert('error', '删除失败: ' + (error.message || '未知错误'));
                }
                console.error('删除备份失败:', error);
            }
        }

        // 加载系统状态
        async function loadSystemStatus() {
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch('/api/status', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('totalDevices').textContent = data.total_devices;
                    document.getElementById('totalBackups').textContent = data.total_backups;
                    
                    const schedulerStatus = document.getElementById('schedulerStatus');
                    if (data.scheduler_running) {
                        schedulerStatus.textContent = '运行中';
                        schedulerStatus.className = 'badge bg-success status-badge';
                    } else {
                        schedulerStatus.textContent = '已停止';
                        schedulerStatus.className = 'badge bg-danger status-badge';
                    }
                    
                    document.getElementById('nextBackup').textContent = data.next_backup_time || '未设置';
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('加载系统状态超时');
                } else {
                    console.error('加载系统状态失败:', error);
                }
            }
        }

        // 刷新数据
        function refreshData() {
            loadDevices();
            loadSystemStatus();
            if (currentDevice) {
                loadBackupHistory(currentDevice);
            }
            showAlert('info', '数据已刷新');
        }


        // 显示加载提示
        function showLoading(message) {
            try {
                const messageEl = document.getElementById('loadingMessage');
                if (messageEl) {
                    messageEl.textContent = message || '处理中...';
                }
                if (loadingModal) {
                    loadingModal.show();
                } else {
                    // 如果loadingModal未初始化，重新初始化
                    const modalElement = document.getElementById('loadingModal');
                    if (modalElement) {
                        loadingModal = new bootstrap.Modal(modalElement);
                        loadingModal.show();
                    }
                }
            } catch (error) {
                console.error('显示loading失败:', error);
            }
        }

        // 隐藏加载提示（强制关闭，不使用动画）
        function hideLoading() {
            try {
                const modalElement = document.getElementById('loadingModal');
                if (modalElement) {
                    // 方法1: 使用Bootstrap的hide方法
                    if (loadingModal) {
                        try {
                            loadingModal.hide();
                        } catch (e) {
                            console.warn('Bootstrap hide失败:', e);
                        }
                    }
                    
                    // 方法2: 直接操作DOM，强制关闭（不等待动画）
                    // 立即移除show类，禁用动画
                    modalElement.classList.remove('show');
                    modalElement.style.display = 'none';
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.removeAttribute('aria-modal');
                    
                    // 移除body的modal-open类
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // 移除backdrop（如果有）
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // 方法3: 尝试获取实例并关闭
                    try {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    } catch (e) {
                        // 忽略错误
                    }
                }
            } catch (error) {
                console.error('关闭loading失败:', error);
                // 最后的保险：直接操作DOM
                try {
                    const modalElement = document.getElementById('loadingModal');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                    }
                } catch (e) {
                    console.error('强制关闭loading也失败:', e);
                }
            }
        }

        // 显示提示消息（异步执行，不阻塞）
        function showAlert(type, message) {
            // 使用requestAnimationFrame确保不阻塞
            requestAnimationFrame(() => {
                try {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // 3秒后自动消失
                    setTimeout(() => {
                        try {
                            alertDiv.remove();
                        } catch (e) {
                            console.error('移除alert失败:', e);
                        }
                    }, 3000);
                } catch (error) {
                    console.error('显示alert失败:', error);
                    // 如果DOM操作失败，至少用console输出
                    console.log(`[${type.toUpperCase()}] ${message}`);
                }
            });
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示添加设备模态框
        function showAddDeviceModal() {
            document.getElementById('deviceModalTitle').textContent = '添加设备';
            document.getElementById('deviceFormMode').value = 'add';
            document.getElementById('deviceFormOldName').value = '';
            document.getElementById('deviceForm').reset();
            document.getElementById('deviceName').readOnly = false;
            document.getElementById('devicePassword').placeholder = '';
            document.getElementById('devicePassword').required = true;
            
            const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
            modal.show();
        }

        // 编辑设备
        function editDevice(name, ip, username, deviceType) {
            document.getElementById('deviceModalTitle').textContent = '编辑设备';
            document.getElementById('deviceFormMode').value = 'edit';
            document.getElementById('deviceFormOldName').value = name;
            
            document.getElementById('deviceName').value = name;
            document.getElementById('deviceName').readOnly = true; // 编辑时不允许修改名称
            document.getElementById('deviceIp').value = ip;
            document.getElementById('deviceUsername').value = username;
            document.getElementById('devicePassword').value = ''; // 密码留空
            document.getElementById('devicePassword').placeholder = '留空则不修改密码';
            document.getElementById('devicePassword').required = false;
            document.getElementById('deviceType').value = deviceType;
            
            const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
            modal.show();
        }

        // 保存设备（添加或编辑）
        async function saveDevice() {
            const mode = document.getElementById('deviceFormMode').value;
            const oldName = document.getElementById('deviceFormOldName').value;
            const name = document.getElementById('deviceName').value.trim();
            const ip = document.getElementById('deviceIp').value.trim();
            const username = document.getElementById('deviceUsername').value.trim();
            const password = document.getElementById('devicePassword').value;
            const deviceType = document.getElementById('deviceType').value;

            // 验证必填字段
            if (!name || !ip || !username || !deviceType) {
                showAlert('warning', '请填写所有必填字段');
                return;
            }

            // 编辑模式下，如果密码为空，需要提示用户
            if (mode === 'edit' && !password) {
                if (!confirm('密码为空，将保持原密码不变。是否继续？')) {
                    return;
                }
            }

            // 添加模式下，密码必填
            if (mode === 'add' && !password) {
                showAlert('warning', '添加设备时密码不能为空');
                return;
            }

            // 不显示loading弹窗，直接执行操作
            //             // 不显示loading弹窗，直接执行操作
            try {
                const url = '/api/devices';
                const method = mode === 'add' ? 'POST' : 'PUT';

                const requestBody = {
                    name: name,
                    ip: ip,
                    username: username,
                    device_type: deviceType
                };

                // 只有密码不为空时才发送密码
                if (password) {
                    requestBody.password = password;
                }

                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.status === 'success') {
                    // 立即关闭模态框（不使用动画，直接隐藏）
                    try {
                        const modalElement = document.getElementById('deviceModal');
                        if (modalElement) {
                            // 直接移除show类，禁用动画
                            modalElement.classList.remove('show');
                            modalElement.style.display = 'none';
                            modalElement.setAttribute('aria-hidden', 'true');
                            modalElement.removeAttribute('aria-modal');
                            
                            // 移除body的modal-open类
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                            
                            // 移除backdrop
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) {
                                backdrop.remove();
                            }
                            
                            // 销毁Bootstrap实例
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.dispose();
                            }
                        }
                    } catch (err) {
                        console.error('关闭模态框失败:', err);
                    }
                    
                    // 清空表单（同步操作，但很快）
                    try {
                        const form = document.getElementById('deviceForm');
                        if (form) form.reset();
                        const modeInput = document.getElementById('deviceFormMode');
                        if (modeInput) modeInput.value = 'add';
                        const oldNameInput = document.getElementById('deviceFormOldName');
                        if (oldNameInput) oldNameInput.value = '';
                    } catch (err) {
                        console.error('清空表单失败:', err);
                    }
                    
                    // 所有后续操作都异步执行，不阻塞
                    // 使用setTimeout(0)确保在下一个事件循环执行
                    setTimeout(() => {
                        // 显示成功消息
                        showAlert('success', data.message);
                        
                        // 刷新设备列表
                        loadDevices().catch(err => {
                            console.error('刷新设备列表失败:', err);
                        });
                    }, 0);
                    
                    // 延迟更新系统状态（不紧急）
                    setTimeout(() => {
                        loadSystemStatus().catch(err => {
                            console.error('更新系统状态失败:', err);
                        });
                    }, 300);
                    
                    // 如果编辑的是当前选中的设备，重新选择
                    if (mode === 'edit' && currentDevice === oldName) {
                        currentDevice = name;
                        setTimeout(() => {
                            loadBackupHistory(name).catch(err => {
                                console.error('加载备份历史失败:', err);
                            });
                        }, 500);
                    }
                } else {
                    // 错误消息异步显示
                    setTimeout(() => {
                        showAlert('error', data.message || '操作失败');
                    }, 0);
                }
            } catch (error) {
                console.error('操作失败:', error);
                showAlert('error', (mode === 'add' ? '添加' : '更新') + '设备失败: ' + (error.message || '未知错误'));
            }
        }

        // 删除设备
        async function deleteDevice(deviceName) {
            if (!confirm(`确定要删除设备 "${deviceName}" 吗？\n\n此操作将删除设备配置，但不会删除备份文件。`)) {
                return;
            }

            // 不显示loading弹窗，直接执行操作
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

                const response = await fetch(`/api/devices?device_name=${encodeURIComponent(deviceName)}`, {
                    method: 'DELETE',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                const data = await response.json();

                if (data.status === 'success') {
                    showAlert('success', data.message);
                    
                    // 如果删除的是当前选中的设备，清除选择
                    if (currentDevice === deviceName) {
                        currentDevice = null;
                        document.getElementById('backupHistory').innerHTML = '<p class="text-muted">请选择一个设备查看备份历史</p>';
                    }
                    
                    // 异步刷新，不阻塞界面
                    setTimeout(() => {
                        loadDevices().catch(err => {
                            console.error('刷新设备列表失败:', err);
                        });
                        loadSystemStatus().catch(err => {
                            console.error('更新系统状态失败:', err);
                        });
                    }, 0);
                } else {
                    showAlert('error', data.message || '删除失败');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('error', '删除设备超时，请检查网络连接');
                } else {
                    showAlert('error', '删除设备失败: ' + (error.message || '未知错误'));
                }
                console.error('删除设备失败:', error);
            }
        }

        // 重置设备表单（当模态框关闭时）
        document.getElementById('deviceModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('deviceForm').reset();
            document.getElementById('deviceName').readOnly = false;
            document.getElementById('devicePassword').placeholder = '';
            document.getElementById('devicePassword').required = true;
        });
    </script>
</body>
</html>

